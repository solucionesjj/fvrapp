<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Barcode Readers - Florida License</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        video {
            width: 100%;
            max-width: 500px;
            height: 300px;
            background: #000;
            border-radius: 4px;
        }
        .result {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            background: #ffe6e6;
            color: #d00;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #e6ffe6;
            color: #060;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Debug Barcode Readers - Florida License Test</h1>
    
    <div class="container">
        <h2>1. Verificaci√≥n de Dispositivos de C√°mara</h2>
        <button onclick="checkCameraDevices()">Verificar Dispositivos</button>
        <div id="devices-result"></div>
    </div>
    
    <div class="container">
        <h2>2. Test de C√°mara con PDF417 Reader</h2>
        <button onclick="startPDF417Camera()" id="pdf417-btn">Iniciar PDF417 Reader</button>
        <button onclick="stopCamera()" id="stop-btn" disabled>Detener C√°mara</button>
        <br><br>
        <video id="video-pdf417" autoplay playsinline style="display: none;"></video>
        <div id="pdf417-result"></div>
    </div>
    
    <div class="container">
        <h2>3. Test de C√°mara con MultiFormat Reader</h2>
        <button onclick="startMultiFormatCamera()" id="multiformat-btn">Iniciar MultiFormat Reader</button>
        <br><br>
        <video id="video-multiformat" autoplay playsinline style="display: none;"></video>
        <div id="multiformat-result"></div>
    </div>
    
    <div class="container">
        <h2>4. Test de Imagen</h2>
        <input type="file" id="file-input" accept="image/*" onchange="testImageDecoding(event)">
        <div id="image-result"></div>
    </div>
    
    <div class="container">
        <h2>5. Log de Eventos</h2>
        <button onclick="clearLog()">Limpiar Log</button>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { BrowserMultiFormatReader, BrowserPDF417Reader } from 'https://unpkg.com/@zxing/browser@latest/esm/index.js';
        
        window.pdf417Reader = new BrowserPDF417Reader();
        window.multiFormatReader = new BrowserMultiFormatReader();
        window.currentStream = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        window.log = log;
        
        window.checkCameraDevices = async function() {
            try {
                log('Verificando dispositivos de c√°mara...');
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                const resultDiv = document.getElementById('devices-result');
                if (videoDevices.length === 0) {
                    resultDiv.innerHTML = '<div class="error">‚ùå No se encontraron dispositivos de c√°mara</div>';
                    log('ERROR: No se encontraron dispositivos de c√°mara');
                } else {
                    let html = '<div class="success">‚úÖ Dispositivos de c√°mara encontrados:</div>';
                    videoDevices.forEach((device, index) => {
                        html += `<div>üìπ ${index + 1}: ${device.label || 'C√°mara sin nombre'} (ID: ${device.deviceId})</div>`;
                        log(`Dispositivo ${index + 1}: ${device.label || 'Sin nombre'} - ${device.deviceId}`);
                    });
                    resultDiv.innerHTML = html;
                }
            } catch (error) {
                const resultDiv = document.getElementById('devices-result');
                resultDiv.innerHTML = `<div class="error">‚ùå Error al verificar dispositivos: ${error.message}</div>`;
                log(`ERROR al verificar dispositivos: ${error.message}`);
            }
        };
        
        window.startPDF417Camera = async function() {
            try {
                log('Iniciando PDF417 Reader...');
                const video = document.getElementById('video-pdf417');
                video.style.display = 'block';
                
                document.getElementById('pdf417-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                
                const resultDiv = document.getElementById('pdf417-result');
                resultDiv.innerHTML = '<div>üîç Escaneando con PDF417 Reader... Muestra una licencia de Florida al c√≥digo</div>';
                
                window.pdf417Reader.decodeFromConstraints(
                    {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    video,
                    (result, error) => {
                        if (result) {
                            log(`‚úÖ PDF417 √âXITO: C√≥digo detectado`);
                            resultDiv.innerHTML = `<div class="success">‚úÖ ¬°C√≥digo PDF417 detectado exitosamente!</div><div class="result">${result.getText()}</div>`;
                            testAAMVAParsing(result.getText());
                        } else if (error && !error.toString().includes('NotFoundException')) {
                            log(`‚ö†Ô∏è PDF417 ERROR: ${error.message}`);
                            resultDiv.innerHTML = `<div class="error">‚ùå Error PDF417: ${error.message}</div>`;
                        }
                    }
                ).catch(error => {
                    log(`‚ùå PDF417 FALLO: ${error.message}`);
                    resultDiv.innerHTML = `<div class="error">‚ùå Error al iniciar PDF417: ${error.message}</div>`;
                    document.getElementById('pdf417-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                });
                
            } catch (error) {
                log(`‚ùå PDF417 EXCEPCI√ìN: ${error.message}`);
                document.getElementById('pdf417-result').innerHTML = `<div class="error">‚ùå Excepci√≥n: ${error.message}</div>`;
            }
        };
        
        window.startMultiFormatCamera = async function() {
            try {
                log('Iniciando MultiFormat Reader...');
                const video = document.getElementById('video-multiformat');
                video.style.display = 'block';
                
                document.getElementById('multiformat-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                
                const resultDiv = document.getElementById('multiformat-result');
                resultDiv.innerHTML = '<div>üîç Escaneando con MultiFormat Reader... Muestra cualquier c√≥digo de barras</div>';
                
                window.multiFormatReader.decodeFromConstraints(
                    {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    video,
                    (result, error) => {
                        if (result) {
                            log(`‚úÖ MULTIFORMAT √âXITO: C√≥digo detectado`);
                            resultDiv.innerHTML = `<div class="success">‚úÖ ¬°C√≥digo detectado con MultiFormat!</div><div class="result">${result.getText()}</div>`;
                            testAAMVAParsing(result.getText());
                        } else if (error && !error.toString().includes('NotFoundException')) {
                            log(`‚ö†Ô∏è MULTIFORMAT ERROR: ${error.message}`);
                            resultDiv.innerHTML = `<div class="error">‚ùå Error MultiFormat: ${error.message}</div>`;
                        }
                    }
                ).catch(error => {
                    log(`‚ùå MULTIFORMAT FALLO: ${error.message}`);
                    resultDiv.innerHTML = `<div class="error">‚ùå Error al iniciar MultiFormat: ${error.message}</div>`;
                    document.getElementById('multiformat-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                });
                
            } catch (error) {
                log(`‚ùå MULTIFORMAT EXCEPCI√ìN: ${error.message}`);
                document.getElementById('multiformat-result').innerHTML = `<div class="error">‚ùå Excepci√≥n: ${error.message}</div>`;
            }
        };
        
        window.stopCamera = function() {
            log('Deteniendo c√°mara...');
            
            // Detener todos los videos
            const videos = document.querySelectorAll('video');
            videos.forEach(video => {
                if (video.srcObject) {
                    const stream = video.srcObject;
                    stream.getTracks().forEach(track => {
                        track.stop();
                        log(`Track detenido: ${track.kind}`);
                    });
                    video.srcObject = null;
                }
                video.style.display = 'none';
            });
            
            // Rehabilitar botones
            document.getElementById('pdf417-btn').disabled = false;
            document.getElementById('multiformat-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            
            log('‚úÖ C√°mara detenida');
        };
        
        window.testImageDecoding = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            log(`Probando decodificaci√≥n de imagen: ${file.name}`);
            
            const resultDiv = document.getElementById('image-result');
            resultDiv.innerHTML = '<div>üîç Procesando imagen...</div>';
            
            try {
                const imageUrl = URL.createObjectURL(file);
                
                // Probar con PDF417 primero
                try {
                    const result = await window.pdf417Reader.decodeFromImageUrl(imageUrl);
                    log('‚úÖ IMAGEN PDF417 √âXITO');
                    resultDiv.innerHTML = `<div class="success">‚úÖ ¬°C√≥digo PDF417 detectado en imagen!</div><div class="result">${result.getText()}</div>`;
                    testAAMVAParsing(result.getText());
                    URL.revokeObjectURL(imageUrl);
                    return;
                } catch (pdf417Error) {
                    log(`‚ö†Ô∏è IMAGEN PDF417 FALLO: ${pdf417Error.message}`);
                }
                
                // Probar con MultiFormat
                try {
                    const result = await window.multiFormatReader.decodeFromImageUrl(imageUrl);
                    log('‚úÖ IMAGEN MULTIFORMAT √âXITO');
                    resultDiv.innerHTML = `<div class="success">‚úÖ ¬°C√≥digo detectado en imagen con MultiFormat!</div><div class="result">${result.getText()}</div>`;
                    testAAMVAParsing(result.getText());
                } catch (multiFormatError) {
                    log(`‚ùå IMAGEN MULTIFORMAT FALLO: ${multiFormatError.message}`);
                    resultDiv.innerHTML = `<div class="error">‚ùå No se pudo decodificar la imagen con ning√∫n lector</div>`;
                }
                
                URL.revokeObjectURL(imageUrl);
                
            } catch (error) {
                log(`‚ùå IMAGEN EXCEPCI√ìN: ${error.message}`);
                resultDiv.innerHTML = `<div class="error">‚ùå Error al procesar imagen: ${error.message}</div>`;
            }
        };
        
        function testAAMVAParsing(text) {
            log('üîç Probando parsing AAMVA...');
            
            // Simular el parsing AAMVA
            const cleanedText = text.replace(/[@\x1e\r]/g, '').trim();
            const lines = cleanedText.split('\n').filter(Boolean);
            
            const fieldMap = {
                ANS: 'licenseCode',
                DAC: 'firstName',
                DAD: 'secondName',
                DAG: 'address',
                DAI: 'city',
                DAJ: 'state',
                DAK: 'postalCode',
                DCS: 'surnames',
                DBB: 'dateOfBirth'
            };
            
            const parsed = {};
            let foundFields = 0;
            
            for (let line of lines) {
                const match = line.match(/^([A-Z]{3})(.*)/); 
                if (match) {
                    const [_, code, value] = match;
                    if (fieldMap[code]) {
                        if (code === 'ANS') {
                            const daqMatch = value.match(/DAQ(.{13})/);
                            parsed[fieldMap[code]] = daqMatch ? daqMatch[1] : '';
                        } else {
                            parsed[fieldMap[code]] = value.trim();
                        }
                        foundFields++;
                        log(`‚úÖ Campo: ${code} -> ${fieldMap[code]} = ${parsed[fieldMap[code]]}`);
                    }
                }
            }
            
            if (foundFields > 0) {
                log(`‚úÖ PARSING √âXITO: ${foundFields} campos encontrados`);
                log(`Datos extra√≠dos: ${JSON.stringify(parsed, null, 2)}`);
            } else {
                log('‚ùå PARSING FALLO: No se encontraron campos AAMVA v√°lidos');
            }
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        // Inicializar
        log('üöÄ Debug tool inicializado');
        log('üìã Instrucciones:');
        log('1. Verifica que tienes dispositivos de c√°mara');
        log('2. Prueba los lectores con una licencia de Florida');
        log('3. Si la c√°mara no funciona, prueba subiendo una imagen');
        log('4. Revisa el log para ver detalles de errores');
        
    </script>
</body>
</html>